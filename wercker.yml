box: clone1018/php55@0.0.1
services:
  - wercker/postgresql
  - wercker/nodejs
build:
  # The steps that will be executed on build
  steps:
    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: install dependencies
        code: |-
          composer config github-oauth.github.com $GH_OAUTH
          composer install --no-interaction --prefer-source
    - script:
        name: clean npm cache
        code: |-
          rm -rf /pipeline/build/node_modules/
          rm -rf ~/.npm
          npm cache clean
    - npm-install
    - plasticine/bower-install@0.0.4
    - hgen/gulp:
        tasks: compile
    - script:
        name: migrate database
        code: php artisan migrate --env=wercker
    - script:
        name: run unit tests
        code: phpunit
  after-steps:
    - wouter/irc-notify@0.0.9:
        server: irc.freenode.net
        port: 6667
        nickname: wercbot
        channel: patchnotes
deploy:
  steps:
    - add-to-known_hosts:
        hostname: patchnotes.org
    - mktemp:
        envvar: PRIVATEKEY_PATH
    - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $DO_PRIVATE
        overwrite: true
    - script:
        name: stop application
        code: |
          ssh -i $PRIVATEKEY_PATH -l patchnotes patchnotes.org "cd /srv/www/patchnotes.org/website/ && php artisan down"
    - script:
        name: transfer application
        code: |
          rsync -a -e "ssh -i $PRIVATEKEY_PATH" /pipeline/build/* patchnotes@patchnotes.org:/srv/www/patchnotes.org/website/
    - script:
        name: migrate database
        code: |
          ssh -i $PRIVATEKEY_PATH -l patchnotes patchnotes.org "cd /srv/www/patchnotes.org/website/ && php artisan migrate"
    - script:
        name: start application
        code: |
          ssh -i $PRIVATEKEY_PATH -l patchnotes patchnotes.org "cd /srv/www/patchnotes.org/website/ && php artisan up"